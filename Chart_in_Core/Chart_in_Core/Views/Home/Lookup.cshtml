@using Microsoft.AspNetCore.Authorization
@using Satistic.Models.ViewModels
@model MoadiViewModel
@{

}
     
<section class="basic-elements" dir="rtl">
    <form method="get" asp-action="Lookup" asp-controller="Home" dir="rtl">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title-wrap bar-success">
                            <h5 class="card-title mb-0">جستجو</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="px-3">
                            <div class="form-body" >
                                <div class="row">
                                    <div class="col-xl-4 col-lg-6 col-md-12 mb-1" >
                                        <fieldset class="form-group">
                                            <label for="basicInput">کد ملی</label>
                                            @Html.ValidationMessageFor(model =>model.CodMelli, "", new { @class = "text-danger" })
                                            <input type="text" asp-for="CodMelli" class="form-control"  id="NationalCode">
                                                
                                        </fieldset>
                                    </div>

                                    <div class="col-xl-4 col-lg-6 col-md-12 mb-1">
                                        <fieldset class="form-group">
                                            <label for="basicSelect">منبع</label>
                                            @Html.ValidationMessageFor(model =>model.ddl_sourceId, "", new { @class = "text-danger" })

                                            <select class="form-control" id="ddl_Source" asp-for="ddl_sourceId" asp-items="@((SelectList)ViewData["ddl_items"])">
                                                <option> انتخاب کنید...</option>
                                            </select>

                                        </fieldset>
                                    </div>
                                    <div class="col-xl-4 col-lg-6 col-md-12 mb-1">
                                        <fieldset class="form-group">
                                            <label for="helpInputTop">سال</label>
                                            @Html.ValidationMessageFor(model =>model.Sal, "", new { @class = "text-danger" })

                                            <input type="text" asp-for="Sal" class="form-control" id="Year">

                                        </fieldset>
                                    </div>


                                    <div class="col-xl-4 col-lg-6 col-md-12 mb-1">
                                        <fieldset class="form-group">
                                            <label for="basicSelect">دوره</label>
                                            @Html.ValidationMessageFor(model =>model.ddl_DoreId, "", new { @class = "text-danger" })

                                            <select class="form-control" id="Dore" asp-for="ddl_DoreId">
                                                <option>انتخاب کنید...</option>
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                            </select>

                                        </fieldset>
                                    </div>


                                    <div class="col-xl-12 col-lg-12 col-md-12 mb-1">
                                        <fieldset class="form-group">
                                            <br />
                                            @*<a onclick="GetSellerProduct()" class="btn btn-success col-md-12">جستجو </a>*@
                                            <input type="submit" class="btn btn-success col-md-12" value="جستجو" />
                                        </fieldset>
                                    </div>


                                </div>
                                @if (Model.MoadiShenases != null)
                                {
                                    <table class="table table-striped table-bordered zero-configuration dataTable" role="grid">
                                        <thead>
                                            <tr>
                                                <th>کد رهگیری</th>
                                                <th>TIN</th>
                                                <th>شناسه مشارکت</th>  
                                                <th>شناسه اظهارنامه</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.MoadiShenases)
                                            {
                                                <tr>
                                                    <td>@Html.DisplayFor(modelItem => item.RahgiriNo)</td>
                                                    <td>@item.TIN</td>
                                                     <td>@item.MosharekatMember</td>
                                                     <td>@item.ShenaseEzharname</td>
                                                    <td>
                                                        @*<input type="hidden" asp-for="@item.TIN" />*@
                                                        <a href="javascript:void()"   onclick="GetDetails('@item.ShenaseEzharname')" >جزئیات</a>
                                                        @*<input type="submit"  value="جزئیات" onclick=" GetDetails('@item.ShenaseEzharname')">*@
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>


                                }

                               @*  <div  id="tbl_chart">
                                  </div>*@
                                
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </form>
     @*<div class="box-body" id="div_Chart"  >*@
                 
       @*</div>*@
 </section>
                  

<script>
function ShowDetailsModal(XLabels,YValues) {
        var xLables=[];
        var yValues=[];
        xLables=XLabels.split(',');
        yValues=YValues.split(',');

        $('#DetailsModal').modal('show');
        setTimeout(function () {
            var modal = $('#DetailsModal');
            //var canvas = modal.find('.modal-body canvas');
            var canvas=document.getElementById("chart");

            // Chart initialisieren
            //var ctx = canvas[0].getContext("2d");
            var ctx = canvas.getContext("2d");
            var chartName = "chart";
            //var ctx = $('#DetailsModal').modal('show').getElementById(chartName).getContext('2d');
            var data = {
                //labels: Html.Raw(XLabels),
                labels: xLables,
                datasets: [{
                    label: "نمودار وضعیت",
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)',
                        'rgba(255, 0, 0)',
                        'rgba(0, 255, 0)',
                        'rgba(0, 0, 255)',
                        'rgba(192, 192, 192)',
                        'rgba(255, 255, 0)',
                        'rgba(255, 0, 255)'
                    ],
                    borderColor: [
                        'rgba(255,99,132,1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)',
                        'rgba(255, 0, 0)',
                        'rgba(0, 255, 0)',
                        'rgba(0, 0, 255)',
                        'rgba(192, 192, 192)',
                        'rgba(255, 255, 0)',
                        'rgba(255, 0, 255)'
                    ],
                    borderWidth: 1,
                    data: yValues
                    //data:YValues
            }]
            };

            var options = {
                maintainAspectRatio: false,
                scales: {
                    yAxes: [{
                        ticks: {
                            min: 0,
                            beginAtZero: true
                        },
                        gridLines: {
                            display: true,
                            color: "rgba(255,99,164,0.2)"
                        }
                    }],
                    xAxes: [{
                        ticks: {
                            min: 0,
                            beginAtZero: true
                        },
                        gridLines: {
                            display: false
                        }
                    }]
                }
            };

            var myChart = new Chart(ctx, {
                options: options,
                data: data,
                type: 'line'

            });
        }, 2000)

    }




function GetDetails(sh_ezharname) {
        var postData = {
            'Sh_ezharname': sh_ezharname,
        };
        

        $.ajax({
            contentType: 'application/x-www-form-urlencoded',
            dataType: 'json',
            type: "GET",
                url: "Details",
                data: postData,
                success: function (data) {
                    //console.log(data)
                    //data=JSON.stringify(data);
                    //alert(data);
                           //if(element.field_Name=="t_TashkhisNo" )
                             //   if( element.field_Value != null )
                             //        document.getElementById('spn_tashkhis').style.backgroundColor="green";

                             //if(element.field_Name=="e_DarkhastEterazNo" ) 
                             //   if( element.field_Value != "" )
                             //       document.getElementById('spn_eteraz').style.backgroundColor="green";
                             //   else
                             //       document.getElementById('spn_tamkin').style.backgroundColor="green";

                             //if(element.field_Name=="gh_GhateeNo")
                             //{
                         
                             //  if( element.field_Value != null  ) 
                             //     document.getElementById('spn_ghatee').style.backgroundColor="green";
                             //}
                    var flg_r_=true;
                    var flg_t_=true;
                    var flg_e_=true;
                    var flg_ec_=true;
                    var flg_b_=true;
                    var flg_bc_=true;
                    var flg_tn_=true;
                    var flg_tnc_=true;
                    var flg_gh_=true;

                    var JsonChart='[';
                     var YValues="";
                     var XLabels="";

                   var htmltext_r_='<table><tbody> ';
                   var htmltext_t_='<table ><tbody> ';
                   var htmltext_e_='<table ><tbody> ';
                   var htmltext_ec_='<table ><tbody> ';
                   var htmltext_b_='<table ><tbody> ';
                   var htmltext_bc_='<table ><tbody> ';
                   var htmltext_tn_='<table ><tbody> ';
                   var htmltext_tnc_='<table ><tbody> ';
                   var htmltext_gh_='<table > <tbody> ';
                   $.each(data, function(index, element) {
                       
                        if(index == data.length -1)
                        {
                            XLabels= XLabels.substring(0, XLabels.length  -1);
                            YValues= YValues.substring(0, YValues.length  -1);
                             ShowDetailsModal(XLabels,YValues);
                        } 
                        if(element.field_Name  == "r_DaramadEbrazi" || element.field_Name == "t_DaramadTashkhis" ||
                                 element.field_Name  == "e_DaramadEteraz" || element.field_Name  == "b_DaramadBadvi" || element.field_Name  == "gh_DaramadGhatee")
                        {
                            if(element.field_Value != "")
                            {
                            //     YValues+= " 0 ," ;
                            //}
                            //else 
                            //{
                                YValues+= element.field_Value +",";
                                XLabels+=element.field_Name +",";

                            }
                            //JsonChart+="{ 'Step':'"+element.field_Name +"',"+"'Value':'"+element.field_Value+"'},";
                        }
                       
                            if(element.field_Name.substring(0,2)=="r_" )
                                if( element.field_Value != null )
                                {
                                    htmltext_r_+=' <tr><td>'+element.field_Name +': </td>' +' <td>'+element.field_Value+' </td> </tr>';
                                    flg_r_=false;
                                }
                              
                             if(element.field_Name.substring(0,2)!="r_" && flg_r_==false)
                            {
                                htmltext_r_ += ' </tbody> </table>';
                                document.getElementById("spn_ezhar").innerHTML=htmltext_r_;
                                flg_r_=true;
                            }
                                      
                           
                            if(element.field_Name.substring(0,2)=="t_" )
                                if( element.field_Value != null )
                                {
                                    htmltext_t_+=' <tr><td>'+element.field_Name +': </td>' +' <td>'+element.field_Value+' </td> </tr>';
                                    flg_t_=false;
                                }
                             if(element.field_Name.substring(0,2)!="t_" && flg_t_==false)
                            {
                                htmltext_t_ += ' </tbody> </table>';
                                document.getElementById("spn_tashkhis").innerHTML=htmltext_t_;
                                flg_t_=true;
                            }
                                
                            // if(element.field_Name.substring(0,2)=="r_" )
                            //    if( element.field_Value != null )
                            //    {
                            //        htmltext_r_+=' <tr><td>'+element.field_Name +': </td>' +' <td>'+element.field_Value+' </td> </tr>';
                            //    }
                            // if(element.field_Name.substring(0,2)!="r_" && flg_r_==false)
                            //{
                            //    htmltext_r_ += ' </tbody> </table>';
                            //    document.getElementById("spn_ezhar").innerHTML=htmltext_r_;
                            //    flg_r_=true;
                            //}
                   });  
                    
                }
                       
        });
                        //alert(XLabels);
                        //YValues= YValues.Substring(0, YValues.Length-1)+"]";
                        // JsonChart=JsonChart.substring(0,JsonChart.length-1)+"]";
       
    }


 function GetSellerProduct() {
            var codmelli = $('#NationalCode').val();
            var postData = {
                'CodMelli': codmelli,
            };
            $.ajax({
                contentType: 'application/x-www-form-urlencoded',
                dataType: 'json',
                type: "GET",
                url: "Details",
                data: postData,
                    success: function (data) {
                       
                }
               
            });
    }

 function openContent(evt, tabName) {
  var i, tabcontent, tablinks;
  tabcontent = document.getElementsByClassName("tabcontent");
  for (i = 0; i < tabcontent.length; i++) {
    tabcontent[i].style.display = "none";
  }
  tablinks = document.getElementsByClassName("tablinks");
  for (i = 0; i < tablinks.length; i++) {
    tablinks[i].className = tablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}
</script>
<script src="~/js/Chart.bundle.min.js"></script>
<script src="~/js/jquery-3.3.1.min.js"></script>

@section Modals
{
 <div id="DetailsModal0" class="modal fade" role="dialog">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
           <h5 class="modal-title" > جزئیات </h5>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      <div class="modal-body" id="tbl_Flowchart">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">بستن</button>
      </div>
    </div>

  </div>
</div>

     <!-- Modal  -->
    <div class="modal" id="DetailsModal" >
     
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" > جزئیات </h5>
                   <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div >

                    <div class="tab" style="background-color: #ceebe1;  overflow: hidden; border: 1px solid #ccc;" dir="rtl">
                        <button class="tablinks" onclick="openContent(event, 'Flowchart')">فلوچارت</button>
                        <button class="tablinks" onclick="openContent(event, 'Chart')">نمودار وضعیت </button>
                    </div>

                    <div id="Flowchart" class="tabcontent">
                                @await Html.PartialAsync("Flowchart")

                    </div>

                     <div id="Chart" class="tabcontent">
                      <h3>نمودار وضعیت </h3>
                         <div class="chart-container">
                                    <canvas id="chart" style="width:400px; height:200px"></canvas>
                                </div>

                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>

            </div>
       
    </div>
}


